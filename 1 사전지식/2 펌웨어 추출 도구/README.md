# 2. 펌웨어 추출 도구

펌웨어 확보는 IoT 기기 분석의 시작점이다. 펌웨어에는 부트로더, 커널, 파일 시스템 등 기기의 동작 원리를 파악할 수 있는 정보가 포함되어 있어, 이를 확보하지 않으면 정적·동적 분석 환경을 구축하기 어렵다. 

펌웨어 확보 방법은 크게 두 가지로 나눌 수 있다.

- 제조사 제공 펌웨어 다운로드
- 하드웨어 기반 펌웨어 추출

가장 간단한 방법은 제조사 공식 홈페이지에서 제공되는 펌웨어 파일을 다운로드하는 것이다. 별도의 장비가 필요 없고 비교적 안전하지만, 모든 제조사가 펌웨어 파일을 제공하는 것은 아니므로 항상 사용 가능한 방법은 아니다. 이러한 경우에는, 기기에 직접 접근해 펌웨어를 추출하는 하드웨어 기반 방법을 활용해야 한다.  

본 문서에서는 하드웨어 기반 방법으로 펌웨어를 추출할 때 사용되는 도구와 진행 절차를 제시함으로써, 후속 문서에서 소개될 펌웨어 추출 실습 과정에 대한 이해를 돕고자 한다. 

# 2.1 UART(Universal Asynchronous Receiver/Transmitter)

UART는 임베디드 시스템 및 IoT 기기에서 디버깅 메시지 출력 및 데이터 전송 수단으로 널리 사용된다. 사용자는 UART를 통해 기기와 호스트를 연결하여 부팅 로그를 확인하거나 환경 변수를 수정하고, 펌웨어를 추출할 수 있다. 

### **2.1.1 UART 핀 구성 및 연결**

UART에는 아래와 같은 네 종류의 핀이 존재하며 기기에 따라 형태가 다를 수 있다. 

| 핀 이름 | 역할 | 설명 |
| --- | --- | --- |
| VCC | 전원 공급 | 보드 전압(3.3V 또는 5V) |
| GND | 접지 | 전위차 기준점 |
| TX | 데이터 송신(칩 기준) | 기기에서 호스트(PC)로 전송하는 신호 |
| RX | 데이터 수신(칩 기준) | 호스트에서 기기로 전송하는 신호 |

### **2.1.2 연결 방법**

UART를 연결할 때, 기기와 호스트의 TX(Transmit)와 RX(Receive)는 교차로 연결되어야 한다. 그리고 UART 통신은 일반적으로 대상 장비가 자체적으로 전원을 공급 받는 상태에서 수행되기 때문에 전압 공급의 중복으로 인한 손상을 방지하기 위해 VCC는 연결하지 않고, TX, RX, GND 세 핀만 연결하는 것이 안전하다. 

이후 USB to TTL 어댑터를 활용하여 기기와 호스트를 연결하고, Putty, Tera Term 등 터미널 프로그램에서 COM 포트와 Baud Rate를 설정하여 시리얼 연결을 열면 부팅 로그 확인, 명령어 전송, 펌웨어 추출 등이 가능하다.

### **2.1.3 통신 설정 - Baud Rate**

Baud rate는 초당 전송되는 단위 신호의 수로, UART 통신에서 얼마나 빠른 속도로 데이터를 전송할지 설정하는 프로토콜이다. Baud rate가 맞지 않으면 원활한 송수신이 이루어지지 못해 데이터가 깨지거나 수신되지 않는다. 

### **2.1.4 UART 핀 식별 방법**

PCB 기판에 TX/RX/GND/VCC 라벨이 표시되어 있으면 간단하게 UART 핀을 식별할 수 있으나, UART 포트가 명시적으로 표시되지 않거나, 디버깅을 방지하기 위해 의도적으로 숨겨져 있는 경우도 있다. 여기에선 멀티미터를 활용하여 핀을 식별하는 방법을 다룬다. 

1. 기기에 탑재된 SoC의 데이터 시트(Data Sheet)를 확인하여 UART TXD/RXD 핀을 찾아 트레이스를 따라가며 후보 핀을 식별한다. 
2. 멀티미터를 통전모드로 변경한 뒤, 검은 색 팁을 보드의 임의의 GND로 추정되는 지점에 연결하고, 빨간 색 팁을 다른 핀에 차례로 접촉한다. 이때 멀티미터에서 삐- 소리가 발생하면 해당 핀이 GND와 연결되어 있음을 의미한다. 
3. GND가 확정되면 GND에는 검은 핀을 접촉시키고 나머지 후보 핀에 빨강 팁을 접촉시키며 전압과 전류를 측정한다. 각 핀 별 전압과 전류의 특징은 아래와 같다. 

| 핀 이름 | 전압 | 전류 |
| --- | --- | --- |
| VCC | 3.3V | 0mA |
| TX | 2V~3.3V | 부팅 시 전류(20mA 이상) |
| RX | 0∼3.3V(풀업/풀다운) | 전류 매우 낮음 |

> 최근 기기는 UART 포트를 숨기거나 비활성화해 식별이 더 어려울 수 있다.
> 

# 2.2 SPI(Serial Peripheral Interface)

SPI는 MCU와 플래시 메모리 간 데이터 교환에 사용되는 동기식 직렬 통신 프로토콜이다. 임베디드 기기에서 펌웨어는 SPI NOR 플래시에 저장되므로, 이 통신 채널을 통해 칩 내부 데이터를 읽을 수 있다.  

UART 접근이 불가능하거나 기기가 부팅되지 않는 경우 SPI 통신을 활용하여 펌웨어를 확보할 수 있다.

# 2.3 롬 라이터(ROM writer)

롬 라이터는 SPI, I2C, UART 등 다양한 버스 신호를 생성·제어해 플래시 메모리를 읽고 지우고 쓰기 작업을 수행하는 USB 기반 전용 하드웨어 인터페이스이다. 대표적으로 CH341A와 같은 저가형 USB 롬 라이터가 많이 사용된다.

# 2.4 Flashrom

Flashrom은 다양한 종류의 비휘발성 플래시 메모리(SPI, LPC, FWH, parallel NOR 등)를 자동 감지·읽기·쓰기·검증할 수 있는 오픈소스 펌웨어 유틸리티이다. 

Flashrom은 플래시 칩의 JEDEC ID(24 비트 제조사·디바이스 식별 코드)를 읽어, 내부 데이터베이스에서 동일한 ID의 칩이 있는지 확인한다. 만약 추출하려는 칩의 정보가 데이터베이스에 존재할 경우 Flashrom은 해당 정보를 활용하여 작업을 수행한다. flashchips.h 코드에서 flashrom에서 지원하는 칩 목록을 확인할 수 있다. 

만약 추출하려는 칩을 Flashrom에서 지원하지 않는 경우, 해당 칩의 데이터 시트를 분석하여 필요한 정보를 획득하고 flashchips.c 파일에 해당 칩에 대한 코드를 추가하고 재빌드하면 Flashrom을 사용하여 펌웨어를 추출할 수 있다. 

## 2.4.1 F**lashrom 옵션**

아무런 옵션도 지정하지 않으면 flashrom은 플래시 칩 탐지(probe)만 수행하며, 탐지·읽기·쓰기 등 칩 접근이 필요한 작업은 `-p/--programmer` 옵션을 지정해야 한다. 

| 옵션 | 의미·용도 |
| --- | --- |
| `-p <programmer>[:params]` | 사용할 프로그래머와 파라미터를 지정한다.  |
| `-r, --read <file>` | 플래시 ROM 내용을 읽어 지정한 파일로 저장한다. 파일이 이미 존재할 경우 덮어쓴다.  |
| `-w, --write (<file>|-)`  | 파일 내용을 플래시 ROM에 기록한다. -를 사용하면 파일 대신 stdin으로부터 읽어온다.  |
| `-E, --erase` | 플래시 ROM의 내용을 지운다. |
| `-V, --verbose` | 더 많은 디버그 메시지를 출력한다. 최대 3번(-VVV)까지 중첩 사용 가능하다. |
| `-L, --list-supported` | 지원되는 칩·프로그래머 목록을 출력한다. |

# 2.5 펌웨어 추출 절차

SPI 통신을 활용한 하드웨어 기반 펌웨어 추출의 흐름은 다음과 같이 정리할 수 있다.

- [ ]  데이터 시트에서 핀 배열(pin out), 전압 등 확인
- [ ]  라즈베리 파이, USB-SPI 어댑터 같은 SPI 인터페이스 준비
- [ ]  플래시 메모리을 읽을 수 있는 도구(flashrom)를 이용해 펌웨어 이미지 덤프
